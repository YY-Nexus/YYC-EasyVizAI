# YYC³ EasyVizAI 部署常见问题与解决方案

## 部署前问题

### 1. 系统要求不满足

#### 问题描述
- Docker版本过低
- 系统内存不足
- 磁盘空间不够

#### 解决方案

**升级Docker**
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# CentOS/RHEL
sudo yum install -y docker-ce docker-ce-cli containerd.io
sudo systemctl start docker
sudo systemctl enable docker
```

**检查系统资源**
```bash
# 检查内存
free -h

# 检查磁盘空间
df -h

# 检查CPU核心数
nproc
```

**释放磁盘空间**
```bash
# 清理系统日志
sudo journalctl --vacuum-size=100M

# 清理包缓存
sudo apt clean  # Ubuntu/Debian
sudo yum clean all  # CentOS/RHEL

# 清理Docker
docker system prune -a
```

### 2. 网络连接问题

#### 问题描述
- 无法拉取Docker镜像
- GitHub连接超时
- DNS解析失败

#### 解决方案

**配置Docker镜像加速**
```bash
# 创建配置文件
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
EOF

# 重启Docker
sudo systemctl restart docker
```

**配置DNS**
```bash
# 临时配置DNS
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf

# 永久配置DNS (Ubuntu)
sudo systemctl disable systemd-resolved
sudo systemctl stop systemd-resolved
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
```

## 部署过程问题

### 3. 部署脚本执行失败

#### 问题描述
- 权限不足
- 依赖检查失败
- 环境变量配置错误

#### 解决方案

**权限问题**
```bash
# 给予执行权限
chmod +x deploy.sh

# 使用sudo执行（如果需要）
sudo ./deploy.sh

# 检查Docker权限
sudo usermod -aG docker $USER
newgrp docker
```

**依赖检查失败**
```bash
# 手动安装依赖
sudo apt update
sudo apt install -y curl netcat-openbsd

# 检查命令是否存在
which docker
which docker-compose
which git
which curl
```

**环境变量问题**
```bash
# 检查环境文件
cat .env.production

# 手动生成密钥
openssl rand -hex 32

# 重新生成环境文件
rm .env.production
./deploy.sh
```

### 4. Docker Compose启动失败

#### 问题描述
- 容器构建失败
- 服务启动超时
- 端口占用冲突

#### 解决方案

**容器构建失败**
```bash
# 查看构建日志
docker-compose -f docker-compose.production.yml build --no-cache

# 逐个构建服务
docker-compose -f docker-compose.production.yml build backend
docker-compose -f docker-compose.production.yml build frontend

# 检查Dockerfile语法
docker build -t test -f deployment/backend/Dockerfile .
```

**服务启动超时**
```bash
# 增加启动超时时间
export COMPOSE_HTTP_TIMEOUT=300
export DOCKER_CLIENT_TIMEOUT=300

# 逐个启动服务
docker-compose -f docker-compose.production.yml up -d postgres
sleep 30
docker-compose -f docker-compose.production.yml up -d redis
sleep 10
docker-compose -f docker-compose.production.yml up -d backend
```

**端口占用**
```bash
# 检查端口占用
sudo netstat -tulpn | grep :80
sudo lsof -i :80

# 停止占用端口的服务
sudo systemctl stop nginx  # 如果有其他nginx
sudo systemctl stop apache2  # 如果有apache

# 修改端口配置
sed -i 's/80:80/8080:80/g' docker-compose.production.yml
```

## 运行时问题

### 5. 数据库连接问题

#### 问题描述
- 数据库无法启动
- 连接被拒绝
- 认证失败

#### 解决方案

**数据库无法启动**
```bash
# 检查数据库容器状态
docker-compose -f docker-compose.production.yml ps postgres

# 查看数据库日志
docker-compose -f docker-compose.production.yml logs postgres

# 检查数据目录权限
sudo chown -R 999:999 deployment/data/postgres/data

# 重置数据库
docker-compose -f docker-compose.production.yml down
sudo rm -rf deployment/data/postgres/data
docker-compose -f docker-compose.production.yml up -d postgres
```

**连接被拒绝**
```bash
# 测试数据库连接
docker-compose -f docker-compose.production.yml exec postgres pg_isready -U easyviz

# 从后端容器测试连接
docker-compose -f docker-compose.production.yml exec backend nc -z postgres 5432

# 检查网络连接
docker network ls
docker network inspect yyceasyvizai_easyviz_network
```

**认证失败**
```bash
# 检查数据库用户
docker-compose -f docker-compose.production.yml exec postgres psql -U postgres -c "\du"

# 重置数据库密码
docker-compose -f docker-compose.production.yml exec postgres psql -U postgres -c "ALTER USER easyviz PASSWORD 'new_password';"

# 更新环境变量
sed -i 's/DB_PASS=.*/DB_PASS=new_password/' .env.production
```

### 6. 前端访问问题

#### 问题描述
- 404页面
- 静态资源加载失败
- 路由不工作

#### 解决方案

**404页面**
```bash
# 检查Nginx配置
docker-compose -f docker-compose.production.yml exec nginx nginx -t

# 检查前端构建产物
docker-compose -f docker-compose.production.yml exec nginx ls -la /usr/share/nginx/html

# 重建前端
docker-compose -f docker-compose.production.yml build --no-cache frontend
docker-compose -f docker-compose.production.yml up -d
```

**静态资源问题**
```bash
# 检查静态文件权限
docker-compose -f docker-compose.production.yml exec nginx ls -la /usr/share/nginx/html/static

# 重新构建前端
docker-compose -f docker-compose.production.yml run --rm frontend npm run build

# 检查Nginx配置
docker-compose -f docker-compose.production.yml exec nginx cat /etc/nginx/conf.d/default.conf
```

**路由问题**
```bash
# 检查前端路由配置
docker-compose -f docker-compose.production.yml exec nginx cat /etc/nginx/conf.d/default.conf | grep "try_files"

# 添加React Router支持
# 确保nginx配置包含: try_files $uri $uri/ /index.html;
```

### 7. API访问问题

#### 问题描述
- API返回500错误
- CORS跨域问题
- 认证失败

#### 解决方案

**API 500错误**
```bash
# 检查后端日志
docker-compose -f docker-compose.production.yml logs backend

# 检查Django配置
docker-compose -f docker-compose.production.yml exec backend python manage.py check --deploy

# 执行数据库迁移
docker-compose -f docker-compose.production.yml exec backend python manage.py migrate
```

**CORS问题**
```bash
# 检查CORS配置
docker-compose -f docker-compose.production.yml exec backend grep -r "CORS" app/settings.py

# 添加前端域名到CORS白名单
# 编辑 backend/app/settings.py 的 CORS_ALLOWED_ORIGINS
```

**认证问题**
```bash
# 创建超级用户
docker-compose -f docker-compose.production.yml exec backend python manage.py createsuperuser

# 检查用户认证
docker-compose -f docker-compose.production.yml exec backend python manage.py shell -c "from django.contrib.auth.models import User; print(User.objects.all())"
```

### 8. 性能问题

#### 问题描述
- 响应缓慢
- 内存使用过高
- CPU占用过高

#### 解决方案

**响应缓慢**
```bash
# 检查服务响应时间
curl -w "@curl-format.txt" -o /dev/null -s http://localhost/health

# 创建curl-format.txt
cat > curl-format.txt << 'EOF'
     time_namelookup:  %{time_namelookup}\n
        time_connect:  %{time_connect}\n
     time_appconnect:  %{time_appconnect}\n
    time_pretransfer:  %{time_pretransfer}\n
       time_redirect:  %{time_redirect}\n
  time_starttransfer:  %{time_starttransfer}\n
                     ----------\n
          time_total:  %{time_total}\n
EOF

# 优化数据库查询
docker-compose -f docker-compose.production.yml exec postgres psql -U easyviz -c "SELECT pg_stat_reset();"
```

**内存使用过高**
```bash
# 检查容器内存使用
docker stats --no-stream

# 限制容器内存
# 在docker-compose.yml中添加:
# deploy:
#   resources:
#     limits:
#       memory: 512M

# 清理内存
sync && echo 3 > /proc/sys/vm/drop_caches
```

**CPU占用过高**
```bash
# 检查进程CPU使用
docker exec $(docker-compose -f docker-compose.production.yml ps -q backend) top

# 优化Gunicorn配置
# 调整worker数量和类型
```

## 日志和监控问题

### 9. 日志问题

#### 问题描述
- 日志文件过大
- 日志轮转不工作
- 找不到日志文件

#### 解决方案

**日志文件过大**
```bash
# 手动清理日志
find deployment/logs -name "*.log" -size +100M -delete

# 配置logrotate
sudo tee /etc/logrotate.d/easyviz << 'EOF'
/path/to/YYC-EasyVizAI/deployment/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    copytruncate
}
EOF
```

**日志轮转不工作**
```bash
# 测试logrotate
sudo logrotate -d /etc/logrotate.d/easyviz

# 强制执行轮转
sudo logrotate -f /etc/logrotate.d/easyviz

# 检查cron服务
sudo systemctl status cron
```

### 10. 备份恢复问题

#### 问题描述
- 备份失败
- 恢复数据失败
- 备份文件损坏

#### 解决方案

**备份失败**
```bash
# 手动备份数据库
docker-compose -f docker-compose.production.yml exec postgres pg_dump -U easyviz -Fc easyviz > backup.dump

# 检查备份权限
ls -la deployment/backups/

# 创建备份目录
mkdir -p deployment/backups
chmod 755 deployment/backups
```

**恢复失败**
```bash
# 检查备份文件完整性
file backup.dump
pg_restore --list backup.dump

# 恢复数据库
docker-compose -f docker-compose.production.yml exec -T postgres pg_restore -U easyviz -d easyviz < backup.dump

# 如果恢复失败，尝试重建数据库
docker-compose -f docker-compose.production.yml down
sudo rm -rf deployment/data/postgres/data
docker-compose -f docker-compose.production.yml up -d postgres
# 等待数据库启动后再恢复
```

## 安全问题

### 11. 安全配置问题

#### 问题描述
- 默认密码未修改
- 端口暴露过多
- SSL证书问题

#### 解决方案

**修改默认密码**
```bash
# 修改数据库密码
docker-compose -f docker-compose.production.yml exec postgres psql -U postgres -c "ALTER USER easyviz PASSWORD 'new_strong_password';"

# 更新环境变量
sed -i 's/DB_PASS=.*/DB_PASS=new_strong_password/' .env.production

# 修改admin密码
docker-compose -f docker-compose.production.yml exec backend python manage.py changepassword admin
```

**端口安全**
```bash
# 检查开放端口
sudo netstat -tulpn

# 配置防火墙
sudo ufw enable
sudo ufw allow 22   # SSH
sudo ufw allow 80   # HTTP
sudo ufw allow 443  # HTTPS
sudo ufw deny 5432  # 禁止外部访问数据库
```

**SSL配置**
```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com

# 手动配置SSL
# 将证书文件放在 deployment/ssl/ 目录
# 更新nginx配置启用HTTPS
```

## 升级问题

### 12. 升级失败

#### 问题描述
- 数据迁移失败
- 配置文件冲突
- 服务不兼容

#### 解决方案

**数据迁移失败**
```bash
# 备份当前数据
docker-compose -f docker-compose.production.yml exec postgres pg_dump -U easyviz easyviz > pre_upgrade_backup.sql

# 检查迁移状态
docker-compose -f docker-compose.production.yml exec backend python manage.py showmigrations

# 手动执行迁移
docker-compose -f docker-compose.production.yml exec backend python manage.py migrate --fake-initial
```

**配置冲突**
```bash
# 备份配置文件
cp .env.production .env.production.backup
cp docker-compose.production.yml docker-compose.production.yml.backup

# 合并配置
# 手动比较新旧配置文件，合并必要的更改
```

## 诊断工具

### 系统诊断脚本

创建诊断脚本 `diagnose.sh`:

```bash
#!/bin/bash

echo "=== YYC³ EasyVizAI 系统诊断 ==="
echo

echo "1. 系统信息:"
echo "OS: $(uname -a)"
echo "Memory: $(free -h | grep Mem)"
echo "Disk: $(df -h | grep -E '/|/var|/home')"
echo

echo "2. Docker信息:"
docker --version
docker-compose --version
echo "Docker status: $(systemctl is-active docker)"
echo

echo "3. 服务状态:"
docker-compose -f docker-compose.production.yml ps
echo

echo "4. 端口检查:"
netstat -tulpn | grep -E ':80|:443|:5432|:6379|:7687|:9000|:6333'
echo

echo "5. 日志大小:"
du -sh deployment/logs/*
echo

echo "6. 磁盘使用:"
du -sh deployment/data/*
echo

echo "7. 最近错误:"
tail -n 20 deployment/logs/*/error.log 2>/dev/null || echo "No error logs found"
```

### 快速修复脚本

创建快速修复脚本 `quick-fix.sh`:

```bash
#!/bin/bash

echo "=== 快速修复常见问题 ==="

# 1. 重启所有服务
echo "1. 重启服务..."
docker-compose -f docker-compose.production.yml restart

# 2. 清理日志
echo "2. 清理大日志文件..."
find deployment/logs -name "*.log" -size +50M -delete

# 3. 清理Docker
echo "3. 清理Docker资源..."
docker system prune -f

# 4. 检查权限
echo "4. 修复权限..."
sudo chown -R $USER:$USER deployment/
chmod -R 755 deployment/

# 5. 健康检查
echo "5. 执行健康检查..."
sleep 30
curl -f http://localhost/health || echo "Health check failed"

echo "快速修复完成!"
```

---

**注意**: 如果以上解决方案都无法解决您的问题，请收集相关日志信息并在GitHub提交Issue，我们将尽快为您提供帮助。

**收集日志命令**:
```bash
# 生成完整诊断报告
./diagnose.sh > diagnostic_report.txt 2>&1
docker-compose -f docker-compose.production.yml logs > docker_logs.txt 2>&1
```